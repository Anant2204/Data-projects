trigger: 
  branches:
    include:
    - dev
    - release1/*

resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: 'mct1espool'
      image: mct1esptwindows
      os: windows
    ##########Stage-Release##########
    stages:
    - stage: BUILD
      displayName: Build Package
      jobs:
      - job: Build
        templateContext:
          outputs:
          - output: pipelineArtifact
            targetPath: $(Build.ArtifactStagingDirectory)
            artifactName: drop
            publishLocation: 'Container'
        workspace:
          clean: all
        steps:
        - checkout: self
          clean: true
          persistCredentials: true

        - task: ArchiveFiles@2
          displayName: Archive Portal
          inputs:
            rootFolderOrFile: '$(Build.SourcesDirectory)/portal'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            replaceExistingArchive: true

    #####Stage-DEV#####
    - stage: DEV1
      dependsOn: BUILD
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/dev'))
      displayName: 'Deploy to DEV1'
      jobs:
      - template: /pipelines/templates/deploymenttask.yml@self
        parameters:
          serviceconnection: 'mct-dev1'
          envName: 'DEV1'
          appName: 'mct-dev1-wa-portal'
          resourceGroupName: 'mct-rg-dev1'
          storageAccountName: 'mctdev1saportal'
          containerName: 'webextension'


    #####Stage-UAT1#####

    - stage: UAT1
      displayName: 'Deploy to UAT1'
      dependsOn: BUILD
      condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/release1/'))
      jobs:
      - template: /pipelines/templates/deploymenttask.yml@self
        parameters:
          serviceconnection: 'mct-uat1'
          envName: 'UAT1'
          appName: 'mct-uat1-wa-portal'
          resourceGroupName: 'mct-rg-uat1'
          storageAccountName: 'mctuat1saportal'
          containerName: 'webextension'

    #####Stage-PROD#####

    - stage: PROD
      displayName: 'Deploy to PROD'
      dependsOn: UAT1
      condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/release1/'))
      jobs:
      - template: /pipelines/templates/deploymenttask.yml@self
        parameters:
          serviceconnection: 'mct-prod'
          envName: 'PROD'
          appName: 'mct-prod-wa-portal'
          resourceGroupName: 'mct-rg-prod'
          storageAccountName: 'mctprodsaportal'
          containerName: 'webextension'

    - stage: PRODDR
      displayName: 'Deploy to PRODDR'
      dependsOn: UAT1
      condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/heads/release1/'))
      jobs:
      - template: /pipelines/templates/deploymenttask.yml@self
        parameters:
          serviceconnection: 'mct-proddr'
          envName: 'PRODDR'
          appName: 'mct-proddr-wa-portal'
          resourceGroupName: 'mct-rg-proddr'
          storageAccountName: 'mctproddrsaportal'
          containerName: 'webextension'

  